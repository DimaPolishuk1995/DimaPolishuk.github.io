"use strict";var propertyCrossApp=angular.module("propertyCrossApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","ui.router","ui.bootstrap","ngStorage","ngMaterial"]);propertyCrossApp.config(["$locationProvider","$stateProvider","$urlRouterProvider","$sceProvider",function(e,r,t,o){o.enabled(!1),t.otherwise("/"),r.state("searchPage",{url:"/",templateUrl:"views/searchPage.html",controller:"SearchPage"}).state("results",{url:"/results",templateUrl:"views/resultsListing.html",controller:"ResultsListing"}).state("property",{url:"/property/:id",templateUrl:"views/propertyDetails.html",controller:"PropertyDetails"}).state("favourites",{url:"/favourites",templateUrl:"views/favourites.html",controller:"FavouritesPage"})}]),propertyCrossApp.controller("SearchPage",["$scope","$rootScope","$state","Properties","LastSearch","$localStorage",function(e,r,t,o,n,a){var i=function(r){r instanceof Array?(e.locations=r,e.showLocations=!0,e.showRecentSearches=!1):(e.errorMessage=r,e.showError=!0)};e.search=function(e){o.search(e).then(function(){t.go("results")},i)},e.searchMyLocation=function(){o.searchByCurrentLocation().then(function(){t.go("results")},i)},e.lastSearches=[],"undefined"!=typeof a.searches&&(e.lastSearches=n.get(),e.showRecentSearches=n.get().length),e.goTofavouritesPage=function(){t.go("favourites")}}]),propertyCrossApp.controller("ResultsListing",["$scope","Properties",function(e,r){function t(){e.title=r.count()+" of "+r.total()+" matches"}e.loadMore=function(){r.loadMore().then(function(r){e.properties=r,t()})},e.properties=r.currentValue(),t()}]),propertyCrossApp.controller("PropertyDetails",["$scope","$stateParams","Properties","$localStorage","$state","GetArray","LocalStorage",function(e,r,t,o,n,a,i){e.favourites=a.getArrayData("favourites"),"undefined"!=typeof o.property&&0==e.favourites.length&&(e.favourites=i.getFavourites());var s=r.id;e.property||(e.property=t.get(s)),e.saveToFavourites=function(){e.favourites.push({price:e.property.price,title:e.property.title,rooms:e.property.rooms,imageURL:e.property.imageURL,summary:e.property.summary}),a.setArrayData("favourites",e.favourites),i.addFavourites(e.favourites),n.go("searchPage")}}]),propertyCrossApp.controller("FavouritesPage",["$scope","LocalStorage",function(e,r){e.favourites=r.getFavourites(),e.removeFavouriteProperty=function(e){r.clearFavouritesById(e,e)}}]),propertyCrossApp.factory("Nestoria",["$resource","$q","LastSearch","$sce",function(e,r,t,o){var n=e(o.trustAsResourceUrl("http://api.nestoria.co.uk/api"),{country:"uk",pretty:"1",action:"search_listings",encoding:"json",listing_type:"buy",callbackKey:"callback"},{search:{method:"JSONP"}});return{search:function(e,o){var a=r.defer();return n.search({place_name:e,page:o},function(r){r=r.response,["100","101","110"].indexOf(r.application_response_code)!=-1?(t.add(e),a.resolve(r)):["200","202"].indexOf(r.application_response_code)!=-1?a.reject(r.locations.map(function(e){return{key:e.place_name,value:e.long_title}})):a.reject("An error occurred while searching. Please check your network connection and try again.")},function(e){a.reject(e)}),a.promise},searchByCoordinates:function(e,o,a){var i=r.defer(),s=e.toFixed(4)+","+o.toFixed(4);return n.search({centre_point:s,page:a},function(e){t.add(s),i.resolve(e.response)},function(e){i.reject(e)}),i.promise}}}]),propertyCrossApp.factory("Properties",["$q","Nestoria","Geolocation",function(e,r,t){var o,n="",a=1,i=[],s=function(e){return e.map(function(e){return{id:e.id,title:e.title,price:e.price_formatted,url:e.thumb_url,imageURL:e.img_url,summary:e.summary,rooms:e.bedroom_number+" bed, "+e.bathroom_number+" bathroom"}})},c=function(t,c){var u=e.defer();return r.search(c,t).then(function(e){for(var r=s(e.listings),p=0,l=r.length;p<l;p++)r[p].id=p;r.length||u.reject("There were no properties found for "+c),i=c!=n?r:i.concat(r),n=c,a=t,o=e,u.resolve(i)},function(e){u.reject(e)}),u.promise},u=function(c,u){var p=e.defer(),l=function(e){r.searchByCoordinates(e.latitude,e.longitude,c).then(function(r){var t=s(r.listings);t.length||p.reject("There were no properties found for "+e.latitude.toFixed(2)+","+e.longitude.toFixed(2)),i=e!=n?t:i.concat(t),n=e,a=c,o=r,p.resolve(i)},function(e){p.reject(e)})};return u?l(u):t.getCurrentPosition().then(function(e){var r={latitude:e.coords.latitude,longitude:e.coords.longitude};l(r)},function(e){p.reject(e)}),p.promise};return{currentValue:function(){return i},count:function(){return i.length},total:function(){return Number(o.total_results)},location:function(){return n},search:function(e){return o=null,i=[],c(1,e)},searchByCurrentLocation:function(){return o=null,i=[],u(1)},loadMore:function(){return"string"==typeof n?c(a+1,n):u(a+1,n)},get:function(e){for(var r=0,t=i.length;r<t;r++)if(i[r].id==e)return i[r];return null}}}]),propertyCrossApp.factory("Geolocation",["$q",function(e){return{getCurrentPosition:function(){var r=e.defer();return navigator.geolocation.getCurrentPosition(function(e){r.resolve(e)},function(e){r.reject(e)}),r.promise}}}]),propertyCrossApp.service("LastSearch",["$q","$rootScope","$localStorage",function(e,r,t){function o(){t.searches=n}if("undefined"==typeof t.searches)var n=[];else var n=t.searches;return{get:function(){return t.searches},add:function(e){var r=n.indexOf(e);return r!=-1&&n.splice(r,1),n.unshift(e),n.length>5&&(n.length=5),o(),n}}}]),propertyCrossApp.factory("GetArray",function(){var e={favourites:[]};return{setArrayData:function(r,t){e[r]=t},getArrayData:function(r){return e[r]}}}),propertyCrossApp.service("LocalStorage",["$localStorage",function(e){this.addFavourites=function(r){e.property=r},this.getFavourites=function(){return e.property},this.clearFavouritesById=function(r){var t=r-r+1;e.property.splice(r,t)}}]);